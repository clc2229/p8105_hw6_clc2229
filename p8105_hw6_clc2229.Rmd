---
title: "Homework 6"
author: "Christopher Crowe"
date: "November 16, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

set.seed(1)

```

### Problem 1

The code chunk below puts the data in a format that is appropriate for modeling. For example, it ensures that predictors of interest are the appropriate data types and removes data from some cities that do not report some data.

```{r}
homicides = read.csv("./data/homicide-data.csv")

homicides = 
  homicides %>% 
  mutate(city_state = paste(city, state, sep = ", "),
         resolved = as.numeric(disposition == "Closed by arrest"),
         victim_race_2 = case_when(
           victim_race == "Asian" ~ "Non-White",
           victim_race == "Black" ~ "Non-White",
           victim_race == "Hispanic" ~ "Non-White",
           victim_race == "Other" ~ "Non-White",
           victim_race == "Unknown" ~ "Non-White",
           victim_race == "White" ~ "White"
         ),
         victim_race = factor(victim_race_2, levels = c("White", "Non-White")),
         victim_age = as.numeric(as.character(victim_age))
  ) %>% 
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")
 
  
```

The following code chunk runs a logistic regression on the dataset and extracts the OR comparing the odds of having a solved homicide for Non-Whites vs. Whites and the corresponding 95% upper and lower confidence limits in Baltimore, MD.  

```{r}
fit_logistic = 
  homicides %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

fit_logistic %>% 
  broom::tidy() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_cl = exp(estimate - (1.96 * std_error)),
         upper_cl = exp(estimate + (1.96 * std_error))
  ) %>%
  filter(term == "victim_raceNon-White") %>% 
  select(OR, lower_cl, upper_cl) %>% 
  knitr::kable(digits = 3)

```

The following code chunk extracts the OR and 95% CI for each city/state in the dataset. 

```{r}

nest_glm_res =
  homicides %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~lm(resolved ~ victim_age + victim_sex + victim_race, data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data)

final_homicides = nest_glm_res %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_cl = exp(estimate - (1.96 * std_error)),
         upper_cl = exp(estimate + (1.96 * std_error))
  ) %>% 
  filter(term == "victim_raceNon-White") %>%
  select(city_state, OR, lower_cl, upper_cl) 
  
final_homicides %>% 
  knitr::kable(digits = 3)
```


The below code chunk creates a plot of the ORs and 95% CIs for victim race (non-white vs. white). Based on this plot, we can see which locations have odds ratios that are significantly different from the null value of 1.0. There are no locations where the odds of being resolved is higher for non-white victims than it is for white victims (i.e. no ORs significantly greater than 1.0). However, we can see quite a few locations where the odds of being resolved is lower for non-white victims than it is for white victims (i.e. some ORs are significantly less than 1.0). Boston, MA has the lowest OR (~0.68). 

```{r}
final_homicides %>% 
  arrange(desc(OR)) %>% 
  mutate(city_state = forcats::fct_inorder(city_state)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_cl, ymax = upper_cl)) +
  labs(
    x = "City & State",
    y = "Estimated Odds Ratio Comparing Non-White to White",
    title = "Odds Ratios of Resolved Homicides Comparing Non-White to White"
  ) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) 
```



### Problem 2

The following code chunk reads in the data.

```{r}
birthweight = read.csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = case_when(
      babysex == 1 ~ "Male",
      babysex == 2 ~ "Female"),
    babysex = fct_relevel(babysex, "Male"),
    frace = case_when(
      frace == 1 ~ "White",
      frace == 2 ~ "Black",
      frace == 3 ~ "Asian",
      frace == 4 ~ "Puerto Rican",
      frace == 8 ~ "Other",
      frace == 9 ~ "Unknown"
      ),
    frace = fct_relevel(frace, "White"),
    mrace = case_when(
      mrace == 1 ~ "White",
      mrace == 2 ~ "Black",
      mrace == 3 ~ "Asian",
      mrace == 4 ~ "Puerto Rican",
      mrace == 8 ~ "Other"
      ),
    mrace = fct_relevel(mrace, "White"),
    malform = case_when(
      malform == 1 ~ "Present",
      malform == 0 ~ "Absent"
    ),
    malform = fct_relevel(malform, "Absent")
    )
  

birthweight %>% 
  ggplot(aes(x = gaweeks, y = bwt)) +
  geom_point()

model_2 = lm(bwt ~ blength + gaweeks, data = birthweight)

model_3 = lm(bwt ~ bhead + blength + babysex + bhead*blength*babysex + bhead*blength + bhead*babysex + blength+babysex, data = birthweight)
```

